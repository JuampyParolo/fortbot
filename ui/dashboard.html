<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè∞ FortBot ‚Äî Guardian</title>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --border: #1e1e2e;
      --text: #e0e0e8;
      --dim: #6c6c80;
      --safe: #22c55e;
      --warning: #f59e0b;
      --block: #ef4444;
      --accent: #6366f1;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }

    .status-dot.connected { background: var(--safe); }
    .status-dot.disconnected { background: var(--block); animation: none; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .stats-bar {
      display: flex;
      gap: 24px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      color: var(--dim);
      background: var(--surface);
    }

    .stat { display: flex; align-items: center; gap: 6px; }
    .stat .val { color: var(--text); font-weight: 600; }
    .stat.safe .val { color: var(--safe); }
    .stat.warning .val { color: var(--warning); }
    .stat.block .val { color: var(--block); }

    .main {
      display: grid;
      grid-template-columns: 1fr 320px;
      height: calc(100vh - 90px);
    }

    .feed {
      overflow-y: auto;
      padding: 16px;
    }

    .sidebar {
      border-left: 1px solid var(--border);
      background: var(--surface);
      overflow-y: auto;
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-section h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--dim);
      margin-bottom: 12px;
    }

    /* Verdict cards */
    .verdict-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
      margin-bottom: 8px;
      border-left: 3px solid var(--dim);
      transition: opacity 0.3s;
    }

    .verdict-card.safe { border-left-color: var(--safe); }
    .verdict-card.warning { border-left-color: var(--warning); }
    .verdict-card.block { border-left-color: var(--block); }
    .verdict-card.new { animation: slideIn 0.3s ease-out; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .verdict-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .verdict-badge {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .verdict-badge.safe { background: #22c55e20; color: var(--safe); }
    .verdict-badge.warning { background: #f59e0b20; color: var(--warning); }
    .verdict-badge.block { background: #ef444420; color: var(--block); }

    .verdict-time { font-size: 10px; color: var(--dim); }

    .verdict-action {
      font-size: 12px;
      color: var(--text);
      word-break: break-all;
      margin-bottom: 4px;
    }

    .verdict-explanation {
      font-size: 11px;
      color: var(--dim);
      line-height: 1.4;
    }

    .verdict-risk {
      font-size: 10px;
      color: var(--dim);
      margin-top: 4px;
    }

    /* Pending approvals */
    .approval-card {
      background: #f59e0b10;
      border: 1px solid #f59e0b40;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .approval-card .action {
      font-size: 11px;
      color: var(--text);
      margin-bottom: 8px;
      word-break: break-all;
    }

    .approval-card .explanation {
      font-size: 10px;
      color: var(--warning);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .approval-buttons {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 6px 14px;
      border-radius: 6px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: opacity 0.2s;
    }

    .btn:hover { opacity: 0.85; }
    .btn.approve { background: var(--safe); color: #000; }
    .btn.deny { background: var(--block); color: #fff; }
    .btn.small { padding: 4px 10px; font-size: 10px; }

    /* Vault */
    .vault-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
    }

    .vault-item .name { color: var(--accent); font-weight: 600; }
    .vault-item .type { color: var(--dim); }
    .vault-item .uses { color: var(--dim); font-size: 10px; }

    .vault-add {
      display: flex;
      gap: 6px;
      margin-top: 10px;
    }

    .vault-add input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-family: inherit;
    }

    .empty-state {
      color: var(--dim);
      font-size: 12px;
      text-align: center;
      padding: 32px 16px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--dim); }

    /* Responsive */
    @media (max-width: 768px) {
      .main { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üè∞ FortBot Guardian</h1>
    <div>
      <span class="status-dot disconnected" id="statusDot"></span>
      <span id="statusText" style="font-size: 11px; color: var(--dim);">Conectando...</span>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat">Total: <span class="val" id="statTotal">0</span></div>
    <div class="stat safe">Safe: <span class="val" id="statSafe">0</span></div>
    <div class="stat warning">Warning: <span class="val" id="statWarning">0</span></div>
    <div class="stat block">Block: <span class="val" id="statBlock">0</span></div>
    <div class="stat">Avg: <span class="val" id="statAvg">0</span>ms</div>
  </div>

  <div class="main">
    <div class="feed" id="feed">
      <div class="empty-state" id="emptyState">
        Esperando acciones del agente...<br>
        <span style="font-size: 10px; margin-top: 8px; display: block;">
          Los veredictos aparecen en tiempo real
        </span>
      </div>
    </div>

    <div class="sidebar">
      <!-- Pending approvals -->
      <div class="sidebar-section">
        <h3>‚è≥ Pendientes (<span id="pendingCount">0</span>)</h3>
        <div id="pendingList">
          <div class="empty-state" style="padding: 16px;">Nada pendiente</div>
        </div>
      </div>

      <!-- Vault -->
      <div class="sidebar-section">
        <h3>üîê Credential Vault</h3>
        <div id="vaultList"></div>
        <div class="vault-add">
          <input type="text" id="vaultName" placeholder="nombre">
          <input type="password" id="vaultValue" placeholder="valor">
          <button class="btn small approve" onclick="addCredential()">+</button>
        </div>
      </div>

      <!-- Quick info -->
      <div class="sidebar-section">
        <h3>‚ÑπÔ∏è Info</h3>
        <div style="font-size: 10px; color: var(--dim); line-height: 1.6;">
          <strong>SAFE</strong> ‚Üí ejecuta sin preguntar<br>
          <strong>WARNING</strong> ‚Üí pregunta antes<br>
          <strong>BLOCK</strong> ‚Üí rechaza siempre<br>
          <br>
          Guardian eval√∫a EFECTOS, no patrones.
          Si el LLM est√° offline, usa heur√≠sticas.
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = 'http://127.0.0.1:18790';
    const WS_URL = 'ws://127.0.0.1:18790/ws';
    
    let ws = null;
    let verdicts = [];
    let reconnectTimer = null;

    // ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function connect() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      
      try {
        ws = new WebSocket(WS_URL);
        
        ws.onopen = () => {
          document.getElementById('statusDot').className = 'status-dot connected';
          document.getElementById('statusText').textContent = 'Conectado';
          if (reconnectTimer) clearInterval(reconnectTimer);
          reconnectTimer = null;
          loadInitialData();
        };
        
        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          handleEvent(msg);
        };
        
        ws.onclose = () => {
          document.getElementById('statusDot').className = 'status-dot disconnected';
          document.getElementById('statusText').textContent = 'Desconectado';
          if (!reconnectTimer) {
            reconnectTimer = setInterval(connect, 3000);
          }
        };
        
        ws.onerror = () => {};
      } catch (e) {
        if (!reconnectTimer) {
          reconnectTimer = setInterval(connect, 3000);
        }
      }
    }

    function handleEvent(msg) {
      const { type, data, timestamp } = msg;
      
      if (type === 'safe' || type === 'warning' || type === 'block') {
        addVerdict({
          verdict: type,
          action: data.action || '',
          explanation: data.explanation || '',
          risk_score: data.risk_score || 0,
          timestamp: timestamp,
        });
      }
      
      if (type === 'approval_resolved') {
        removeApproval(data.approval_id);
      }
      
      updateStats();
      loadPending();
    }

    // ‚îÄ‚îÄ Verdicts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function addVerdict(v) {
      verdicts.unshift(v);
      if (verdicts.length > 200) verdicts.pop();
      renderVerdicts();
    }

    function renderVerdicts() {
      const feed = document.getElementById('feed');
      const empty = document.getElementById('emptyState');
      
      if (verdicts.length === 0) {
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      
      feed.innerHTML = verdicts.map((v, i) => `
        <div class="verdict-card ${v.verdict} ${i === 0 ? 'new' : ''}">
          <div class="verdict-header">
            <span class="verdict-badge ${v.verdict}">${v.verdict}</span>
            <span class="verdict-time">${formatTime(v.timestamp)}</span>
          </div>
          <div class="verdict-action">${escapeHtml(v.action)}</div>
          <div class="verdict-explanation">${escapeHtml(v.explanation)}</div>
          ${v.risk_score > 0 ? `<div class="verdict-risk">Risk: ${(v.risk_score * 100).toFixed(0)}%</div>` : ''}
        </div>
      `).join('');
    }

    // ‚îÄ‚îÄ Pending approvals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function loadPending() {
      try {
        const resp = await fetch(`${API}/guardian/pending`);
        const data = await resp.json();
        const entries = Object.entries(data);
        
        document.getElementById('pendingCount').textContent = entries.length;
        const list = document.getElementById('pendingList');
        
        if (entries.length === 0) {
          list.innerHTML = '<div class="empty-state" style="padding: 16px;">Nada pendiente</div>';
          return;
        }
        
        list.innerHTML = entries.map(([id, item]) => `
          <div class="approval-card">
            <div class="action">${escapeHtml(item.request?.action_content?.substring(0, 200) || 'Acci√≥n desconocida')}</div>
            <div class="explanation">${escapeHtml(item.verdict?.explanation || '')}</div>
            <div class="approval-buttons">
              <button class="btn approve" onclick="resolveApproval('${id}', true)">‚úì Aprobar</button>
              <button class="btn deny" onclick="resolveApproval('${id}', false)">‚úó Rechazar</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        // Guardian offline
      }
    }

    async function resolveApproval(id, approved) {
      try {
        await fetch(`${API}/guardian/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ approval_id: id, approved, user_note: '' }),
        });
        loadPending();
      } catch (e) {
        console.error('Approval error:', e);
      }
    }

    function removeApproval(id) {
      loadPending();
    }

    // ‚îÄ‚îÄ Vault ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function loadVault() {
      try {
        const resp = await fetch(`${API}/vault/list`);
        const data = await resp.json();
        const list = document.getElementById('vaultList');
        
        if (data.length === 0) {
          list.innerHTML = '<div style="font-size: 11px; color: var(--dim); padding: 8px 0;">Sin credenciales guardadas</div>';
          return;
        }
        
        list.innerHTML = data.map(c => `
          <div class="vault-item">
            <div>
              <span class="name">{{${c.name}}}</span>
              <span class="type">${c.type}</span>
            </div>
            <span class="uses">${c.use_count}√ó</span>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('vaultList').innerHTML = 
          '<div style="font-size: 11px; color: var(--dim);">Vault no disponible</div>';
      }
    }

    async function addCredential() {
      const name = document.getElementById('vaultName').value.trim();
      const value = document.getElementById('vaultValue').value;
      
      if (!name || !value) return;
      
      try {
        await fetch(`${API}/vault/store`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, value, description: '', credential_type: 'api_key' }),
        });
        document.getElementById('vaultName').value = '';
        document.getElementById('vaultValue').value = '';
        loadVault();
      } catch (e) {
        console.error('Vault store error:', e);
      }
    }

    // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function updateStats() {
      try {
        const resp = await fetch(`${API}/guardian/stats`);
        const data = await resp.json();
        
        document.getElementById('statTotal').textContent = data.total_evaluations || 0;
        document.getElementById('statSafe').textContent = data.safe || 0;
        document.getElementById('statWarning').textContent = data.warning || 0;
        document.getElementById('statBlock').textContent = data.block || 0;
        document.getElementById('statAvg').textContent = (data.avg_ms || 0).toFixed(1);
      } catch (e) {
        // Guardian offline
      }
    }

    // ‚îÄ‚îÄ Initial load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function loadInitialData() {
      // Load recent audit entries as initial verdicts
      try {
        const resp = await fetch(`${API}/audit/recent?limit=50`);
        const data = await resp.json();
        
        verdicts = data
          .filter(e => ['safe', 'warning', 'block'].includes(e.verdict))
          .map(e => ({
            verdict: e.verdict,
            action: e.action_content || '',
            explanation: e.explanation || '',
            risk_score: e.risk_score || 0,
            timestamp: e.timestamp,
          }))
          .reverse();
        
        renderVerdicts();
      } catch (e) {
        // No audit data
      }
      
      updateStats();
      loadPending();
      loadVault();
    }

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(ts) {
      try {
        const d = new Date(ts);
        return d.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      } catch (e) {
        return ts || '';
      }
    }

    // ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    document.addEventListener('keydown', (e) => {
      // Ctrl+Shift+A = approve first pending
      if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        const firstBtn = document.querySelector('.approval-card .btn.approve');
        if (firstBtn) firstBtn.click();
      }
      // Ctrl+Shift+D = deny first pending
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        const firstBtn = document.querySelector('.approval-card .btn.deny');
        if (firstBtn) firstBtn.click();
      }
    });

    // ‚îÄ‚îÄ Start ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    connect();
    // Poll stats every 10s as fallback
    setInterval(updateStats, 10000);
    setInterval(loadPending, 5000);
    setInterval(loadVault, 30000);
  </script>
</body>
</html>
